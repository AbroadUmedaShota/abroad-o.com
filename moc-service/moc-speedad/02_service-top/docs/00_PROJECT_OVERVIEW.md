# SPEED AD 要件定義書

**文書バージョン:** 1.3
**作成日:** 2025年05月21日 (システム更新日)
**作成者:** [担当者名/システム]

**改訂履歴**

| バージョン | 改訂日     | 改訂内容                                                                                                | 改訂者         |
| :--------- | :--------- | :------------------------------------------------------------------------------------------------------ | :------------- |
| 1.0        | 2025/04/30 | 初版作成 (Backlog転記版ベース)                                                                             | 梅田翔太 (原文) |
| 1.1        | (前回更新)  | HTMLモックに基づき、アンケート作成・回答機能要件を詳細化                                                                | [システム]      |
| 1.2        | (前回更新)  | アンケート回答送信処理への冪等性制御適用、および関連する横断的要件として冪等性制御の項を追加                                            | [システム]      |
| **1.3**    | **2025/05/21** | **「【00.要件定義書】2025-05-21※Backlog転記済.txt」をベースに、冪等性制御要件を統合、およびデータ入力画面のOCR結果表示に関する注釈を反映** | **[システム]**   |
|            |            |                                                                                                         |                |

## 目次

1.  [はじめに](#1-はじめに)
    1.1. [本書の目的](#11-本書の目的)
    1.2. [背景と課題](#12-背景と課題)
    1.3. [システム概要](#13-システム概要)
    1.4. [開発の目的](#14-開発の目的)
    1.5. [用語定義](#15-用語定義)
2.  [システム化の範囲（スコープ）](#2-システム化の範囲スコープ)
    2.1. [システム化する業務範囲](#21-システム化する業務範囲)
    2.2. [システム化しない業務範囲](#22-システム化しない業務範囲)
    2.3. [ターゲットユーザー](#23-ターゲットユーザー)
3.  [機能要件](#3-機能要件)
    3.1. [機能一覧](#31-機能一覧)
    3.2. [ユーザー向け機能](#32-ユーザー向け機能)
    3.3. [管理者向け機能](#33-管理者向け機能)
    3.4. [ワークフロー](#34-ワークフロー)
    3.5. [横断的機能要件](#35-横断的機能要件)
4.  [非機能要件](#4-非機能要件)
    4.1. [性能](#41-性能)
    4.2. [可用性](#42-可用性)
    4.3. [セキュリティ](#43-セキュリティ)
    4.3. [セキュリティ](#43-セキュリティ)
    4.4. [運用・保守](#44-運用保守)
    4.5. [UI/UX](#45-uiux)
5.  [システム構成](#5-システム構成)
    5.1. [全体構成](#51-全体構成)
    5.2. [ソフトウェア構成](#52-ソフトウェア構成)
6.  [データモデル](#6-データモデル)
    6.1. [主要データエンティティ](#61-主要データエンティティ)
7.  [インターフェース要件](#7-インターフェース要件)
    7.1. [冪等性キー払い出しAPI](#71-冪等性キー払い出しapi)
8.  [制約事項](#8-制約事項)

### 1. はじめに

**1.1. 本書の目的**
本書は、展示会・セミナー支援WEBアプリケーション「SPEED AD」（以下、本システム）の開発における要件を定義することを目的とします。本システムが提供すべき機能、性能、制約等を明確にし、開発関係者間の共通認識を形成します。

**1.2. 背景と課題**
展示会やセミナーは重要なリード獲得機会ですが、アンケート作成、名刺のデータ化、お礼メール送信、データ管理といったプロセスが分断され、非効率的であるという課題があります。特に、リードへのアプローチ遅延、データ入力コストの増大、情報管理の属人化などが問題となっています。

**1.3. システム概要**
本システムは、展示会やセミナーにおける一連のリードマネジメントプロセス（アンケート作成・管理、名刺データ化、お礼メール送信、データエクスポート、グループ管理）を一元的に支援するWEBアプリケーションです。

**1.4. 開発の目的**
本システムの開発により、以下の実現を目指します。
*   リード獲得からフォローアップまでの時間短縮と効率化
*   データ入力・管理コストの削減
*   ペーパーレス化の促進と非接触対応の実現
*   企業内でのリード情報の一元管理と活用促進
*   展示会・セミナーにおける投資対効果の最大化

**1.5. 用語定義**
*   **アンケート:** 本システムで作成・管理される質問群。
*   **名刺データ化:** 撮影された名刺画像をテキスト情報に変換し、データベースに登録するプロセス。
*   **お礼メール:** アンケート回答者に対して送信される謝意を示す電子メール。
*   **ユーザー:** 本システムの一般利用者（アンケート作成者、グループ管理者など）。
*   **管理者:** 本システムの運用・管理を行う担当者（アブロード社員、オペレーター管理者、オペレーターなど）。
*   **グループ:** 複数ユーザーでアンケートを共有・管理するための単位。
*   **会期:** アンケートの回答を受け付ける期間。
*   **ステータス:** アンケートの進行状況を示す状態（会期前、会期中、データ化中など）。
*   **プラン:** 名刺データ化の対象項目やスピードに応じた料金プラン。
*   **冪等性キー (Idempotency Key):** クライアントからのリクエストが複数回送信された場合に、サーバー側でそのリクエストが同一のものであることを識別し、処理を一度だけ実行するために使用される一意のキー。

### 2. システム化の範囲（スコープ）

**2.1. システム化する業務範囲**
*   WEBアンケートの作成、編集、コピー、削除
*   アンケート回答の受付、保存
*   名刺画像のアップロード、OCR処理、手入力、照合、データ確定
*   名刺データ化プランの設定、依頼
*   お礼メールテンプレートの設定、送信指示
*   アンケート回答データ、名刺データ、名刺画像のダウンロード
*   ユーザーアカウント管理（登録、編集、パスワードリセット）
*   請求書発行・送付の自動化（管理画面でのデータ作成・確認まで）
*   グループ管理（作成、参加承認、メンバー招待・削除）
*   管理者によるユーザー、アンケート、請求、クーポン、カレンダー、オペレーター、実績の管理
*   データ入力・照合業務の管理・実行
*   リクエストの多重送信防止のための冪等性制御

**2.2. システム化しない業務範囲**
*   外部CRM/SFAシステムとの直接連携（初期フェーズ）
*   決済機能
*   高度なデータ分析・レポーティング機能（基本的な集計まで）

**2.3. ターゲットユーザー**
*   **ユーザー:** 展示会・セミナーに出展・開催する企業の担当者（マーケティング、営業、イベント担当など）
*   **管理者:**
    *   システム運用管理者（アブロードマネージャー、アブロードスタッフ）
    *   データ入力・照合業務管理者（オペレーター管理者）
    *   データ入力・照合担当者（オペレーター）

### 3. 機能要件

**3.1. 機能一覧**
以下の機能を実装します。詳細は各項で記述します。

*   **ユーザー向け機能**
    *   アカウント管理
    *   ダッシュボード（トップ画面）
    *   アンケート作成・管理
    *   アンケート回答
    *   名刺データ化設定
    *   お礼メール設定・送信
    *   データエクスポート
    *   グループ管理
    *   その他（規約、ヘルプ等）
*   **管理者向け機能**
    *   アカウント管理
    *   ユーザー管理
    *   アンケート管理
    *   請求管理
    *   クーポン管理
    *   営業日カレンダー管理
    *   データ入力・照合管理
    *   オペレーター管理
    *   実績管理
*   **横断的機能**
    *   冪等性制御

**3.2. ユーザー向け機能**

*   **3.2.1. アカウント管理**
    *   ログイン/ログアウト機能
    *   パスワードリセット機能（メール経由）
    *   パスワード変更機能
    *   ユーザー情報（氏名、連絡先等）編集機能
    *   会社情報編集機能
*   **3.2.2. ダッシュボード（トップ画面）**
    *   自身が関与するアンケート一覧を表示（ステータス表示含む）
    *   アンケート新規作成機能への導線
    *   グループ管理機能への導線
    *   （内部処理）アンケート名、タイトル、期間等を入力し、アンケート作成プロセスを開始
*   **3.2.3. アンケート作成・管理**
    *   アンケート新規作成、編集、コピー、削除（運用前のみ）機能
    *   アンケートタイトル、説明文、会期、メモの設定
    *   設問追加・編集・削除・並び替え機能（ドラッグ＆ドロップ等による直感的な操作を想定）
    *   **設問タイプ選択機能:** 以下のタイプから選択可能とする。
        *   **単一回答 (Single Answer):** ラジオボタン形式。
        *   **複数回答 (Multiple Answer):** チェックボックス形式。
        *   **テキスト回答 (Text Answer / Free Answer):** 自由記述。単一行/複数行の選択。
        *   **数値回答 (Number Answer):** 数値入力。
        *   **ドロップダウンリスト (Dropdown):** プルダウン選択形式。
        *   **尺度/評定尺度 (Scale):** 段階評価。ラジオボタン形式（例: 5段階評価）。
        *   **マトリックス/グリッド (Matrix):** 行項目と列項目（尺度）による表形式。単一選択(SA)/複数選択(MA)に対応。
        *   **日付/時刻 (Datetime):** 日付のみ、時刻のみ、日付と時刻の入力形式を選択。
        *   **手書きスペース (Handwriting Space):** 回答者が自由に描画できるエリア。
    *   **設問共通設定:**
        *   質問文設定
        *   必須回答設定（チェックボックスでON/OFF）
    *   **設問タイプ別詳細設定:**
        *   **単一/複数/ドロップダウン/尺度:**
            *   選択肢の追加・編集・削除・並び替え機能。
            *   「その他」選択肢の追加機能（選択時に自由記述欄を表示）。
        *   **複数回答:**
            *   最小選択数、最大選択数（0は無制限）の設定。
        *   **テキスト回答:**
            *   入力形式（単一行/複数行）選択。
            *   最小文字数、最大文字数（0は無制限）の設定。
            *   入力ガイドテキスト（Placeholder）の設定。
        *   **数値回答:**
            *   最小値、最大値の設定。
            *   数値形式（整数/小数点）選択。
            *   単位（例: 歳、円）の設定。
        *   **マトリックス/グリッド:**
            *   行項目の追加・編集・削除。
            *   列項目（尺度）の追加・編集・削除。
    *   **作成済み設問リスト表示:** 追加した設問を簡易プレビュー形式で一覧表示する。
    *   名刺撮影機能の要否設定
    *   連続回答機能の要否設定
    *   リアルタイムプレビュー機能
    *   QRコード生成・表示機能
    *   アンケート情報、設問情報の保存機能（手動保存）
    *   会期終了後のアンケート編集不可制御
*   **3.2.4. アンケート回答**
    *   QRコード読み取り等による回答画面表示
    *   各設問タイプに応じた回答インターフェースを提供:
        *   単一回答/尺度: ラジオボタン
        *   複数回答: チェックボックス
        *   テキスト回答: テキスト入力フィールド（単一行/複数行）
        *   数値回答: 数値入力フィールド
        *   ドロップダウンリスト: セレクトボックス
        *   マトリックス/グリッド: 表形式内のラジオボタン/チェックボックス
        *   日付/時刻: 専用カレンダー/時刻ピッカー
        *   手書きスペース: キャンバス描画エリア（ペン、消しゴム、戻る機能）
    *   **回答入力支援・制御:**
        *   数値入力時の全角数字から半角数字への自動変換。
        *   単一/複数回答で「その他」を選択した場合、関連するテキスト入力欄を自動で有効化/必須化。選択解除時は無効化/任意化し入力値をクリア。
        *   複数回答選択時の選択数をリアルタイムで表示。
    *   名刺画像アップロード機能（表裏）
    *   名刺情報手入力機能（名刺がない場合）
    *   **クライアントサイドバリデーション:**
        *   必須項目の未入力チェック。
        *   複数回答の最小/最大選択数チェック。
        *   テキスト回答の最小/最大文字数チェック。
        *   数値回答の最小/最大値チェック。
        *   マトリックスの全行回答チェック。
    *   **エラーハンドリング:**
        *   バリデーションエラー発生時、該当箇所にエラーメッセージを表示し、入力欄のスタイルを変更（例: 赤枠）。
        *   送信ボタン押下時にエラーがある場合、最初のエラー箇所に自動スクロールしフォーカスを当てる。
    *   回答データ、名刺画像、手書き画像の保存処理
    *   （内部処理）名刺画像のOCR処理（非同期）
    *   **送信処理:**
        *   送信ボタン押下時の連打防止制御（ボタンの無効化とラベル変更）。
        *   **【冪等性制御適用】** (詳細は3.5.1. 参照)
            1.  フロントエンドは回答送信直前に冪等性キーを取得。
            2.  取得したキーをリクエストヘッダーに含めて回答保存APIを呼び出す。
            3.  サーバー側はキーを検証し、初回のみ処理を実行。
            4.  フロントエンドはAPIレスポンスがあるまで送信ボタンを無効化、ローディング表示。再試行時は同キー使用。
        *   送信完了/失敗メッセージの表示。
        *   送信成功時のフォームリセット（オプション）。
    *   サンクス画面表示
    *   連続回答機能（設定時）
*   **3.2.5. 名刺データ化設定**
    *   アンケートに紐づく名刺データ化の設定・依頼
    *   データ化項目プラン（無料/標準/プレミアム）選択機能
    *   データ化スピードプラン（通常/特急/超特急/オンデマンド）選択機能
    *   想定件数入力機能
    *   クーポンコード入力・適用機能
    *   請求見込み金額のリアルタイム表示機能
    *   設定内容の保存・依頼確定機能 **【冪等性制御適用対象】** (詳細は3.5.1. 参照)
    *   （内部処理）有料プラン選択時のアカウント情報登録チェック
    *   （内部処理）クーポン有効性チェック
    *   （内部処理）データ完了予定日の計算
*   **3.2.6. お礼メール設定・送信**
    *   アンケートに紐づくお礼メールの設定
    *   お礼メール送信要否設定
    *   メールテンプレート選択機能
    *   メール件名・本文の編集機能（会社名、氏名等の変数埋め込み対応）
    *   設定内容の保存機能
    *   送信対象者リスト表示（会期終了後）
    *   お礼メール送信実行機能（データ化完了後、手動トリガー） **【冪等性制御適用対象】** (詳細は3.5.1. 参照)
    *   送信ステータス管理
*   **3.2.7. データエクスポート**
    *   アンケート回答データのCSVダウンロード機能（会期前は全データ、会期後はテスト回答除く）
    *   名刺データ化完了データのCSVダウンロード機能
    *   名刺画像（表裏）の一括ZIPダウンロード機能
    *   ダウンロードファイル名の命名規則適用
*   **3.2.8. グループ管理**
    *   グループ新規作成機能 **【冪等性制御適用対象の可能性あり】** (詳細は3.5.1. 参照)
    *   グループへの参加申請・承認機能 **【冪等性制御適用対象の可能性あり】**
    *   グループメンバー一覧表示
    *   グループへのメンバー招待機能（メール送信） **【冪等性制御適用対象の可能性あり】**
    *   グループからのメンバー削除機能 **【冪等性制御適用対象の可能性あり】**
    *   グループ内でのアンケート共有設定
*   **3.2.9. その他**
    *   利用規約表示画面
    *   特定商取引法に基づく表示画面
    *   ヘルプ・FAQ表示画面

**3.3. 管理者向け機能**

*   **3.3.1. アカウント管理**
    *   管理者ログイン/ログアウト機能
    *   権限に応じたメニュー表示制御（マネージャー/スタッフ/オペレーター管理者/オペレーター）
*   **3.3.2. ユーザー管理**
    *   全ユーザーアカウント一覧表示（ページネーション付き）
    *   ユーザー検索機能（ID、氏名、会社名等）
    *   ユーザー詳細情報表示・編集機能 **【冪等性制御適用対象】** (詳細は3.5.1. 参照)
    *   アカウント停止・再開機能 **【冪等性制御適用対象】**
    *   管理フラグ・メモ設定機能 **【冪等性制御適用対象】**
*   **3.3.3. アンケート管理**
    *   全アンケート一覧表示（ページネーション付き）
    *   アンケート検索機能（ID、名称、会社名、ステータス等）
    *   アンケート詳細情報表示・編集機能（ユーザー代行） **【冪等性制御適用対象】**
    *   アンケート削除機能 **【冪等性制御適用対象】**
    *   アンケートステータス手動変更機能 **【冪等性制御適用対象】**
    *   名刺画像ダウンロード機能
    *   名刺データ化完了CSVアップロード機能
*   **3.3.4. 請求管理**
    *   アンケート単位の請求情報一覧表示（ページネーション付き）
    *   請求情報検索機能（アンケートID、会社名、ステータス等）
    *   請求情報詳細表示
    *   請求金額、請求日、入金日等の手動編集機能 **【冪等性制御適用対象】**
    *   請求書単位での情報一覧表示（ページネーション付き）
    *   請求書検索機能
    *   請求書プレビュー・ダウンロード機能 (PDF形式想定)
*   **3.3.5. クーポン管理**
    *   発行済みクーポン一覧表示（ページネーション付き）
    *   クーポン検索機能（コード、名称等）
    *   クーポン新規作成機能（コード自動生成、割引率、有効期限等設定） **【冪等性制御適用対象】**
    *   クーポン情報編集機能 **【冪等性制御適用対象】**
    *   クーポン利用履歴表示機能
*   **3.3.6. 営業日カレンダー管理**
    *   カレンダー表示
    *   休日（土日祝以外）の追加・削除機能 **【冪等性制御適用対象】**
*   **3.3.7. データ入力・照合管理**
    *   **データ入力一覧:**
        *   グループ（項目群）別入力対象件数表示
        *   入力優先度表示（オンデマンド > 超特急 > 特急 > 通常）
        *   各グループへの入力画面遷移
        *   （内部処理）メールアドレス未入力時の他グループ入力不可制御
    *   **データ入力画面:**
        *   担当オペレーターへの入力対象名刺（1件）自動割当・表示
        *   名刺画像表示
        *   OCR結果表示（参考）  **⇒現状仕様には無い。実装するか検討＠2025/05/02**
        *   各項目入力フィールド
        *   入力データ保存機能 **【冪等性制御適用対象】**
        *   スキップ機能（理由選択） **【冪等性制御適用対象】**
        *   入力終了機能
        *   （内部処理）入力担当者重複防止のための占有ロック機能（時間制限付き）
        *   （内部処理）入力データと既存データ（OCR含む）の自動照合
        *   （内部処理）3回スキップ時のエスカレーションフラグ設定
        *   （内部処理）3回入力完了時の入力不可フラグ設定
    *   **照合一覧画面:**
        *   アンケート単位での照合状況表示（総件数、一致、不一致、未入力、エスカレーション件数）
        *   照合対象アンケート検索機能
        *   照合画面への遷移
    *   **照合画面:**
        *   回答単位での入力データ（OCR、オペレーター入力×最大3）比較表示
        *   DB登録情報（過去データ）の比較表示
        *   名刺画像表示
        *   項目ごとの正データ選択・修正入力機能
        *   項目ごとの確定チェック機能
        *   エスカレーション機能（判断困難時） **【冪等性制御適用対象】**
        *   照合完了（次の回答へ）機能 **【冪等性制御適用対象】**
        *   （内部処理）照合結果のDB（`input_business_cards.corrected_data`等）への保存
        *   （内部処理）CSVダウンロード用データへの反映
        *   （内部処理）オペレーター入力精度チェック用データの記録
*   **3.3.8. オペレーター管理**
    *   オペレーターアカウント一覧表示
    *   オペレーター検索機能
    *   オペレーター新規作成機能（アカウント発行、パスワード通知） **【冪等性制御適用対象】**
    *   オペレーター情報編集機能 **【冪等性制御適用対象】**
    *   オペレーター削除機能 **【冪等性制御適用対象】**
*   **3.3.9. 実績管理**
    *   グループ（項目群）別入力実績表示（件数、平均正答率など）
    *   オペレーター別入力実績表示（期間、グループ指定、件数、エラー数など）
    *   実績データ集計・表示機能

**3.4. ワークフロー**

*   **3.4.1. アンケートステータスフロー**
    1.  **会期前 (status=1):** 新規作成～会期開始前。編集可能。
    2.  **会期中 (status=2):** 回答受付中。基本的な編集不可。
    3.  **データ化中 (status=3):** 会期終了後、データ化依頼ありの場合。管理者によるデータ入力・照合フェーズ。
    4.  **アップ待ち (status=4):** データ化完了後、CSVアップロード前。
    5.  **アップ完了 (status=5):** CSVアップロード完了後。ユーザーダウンロード可能。お礼メール送信可能。
    6.  **データ化なし (status=6):** 会期終了後、データ化依頼なしの場合。
*   **3.4.2. 名刺データ化ワークフロー**
    1.  ユーザーが名刺画像をアップロード。
    2.  システムがOCR処理を実行（非同期）。
    3.  管理者がデータ入力一覧から対象を選択し、入力画面へ遷移。
    4.  オペレーターがOCR結果を参考に手入力（担当者を変え最大3回）。
    5.  システムが入力データの一致/不一致を判定。
    6.  管理者が照合一覧から対象を選択し、照合画面へ遷移。
    7.  管理者が入力データ、OCR結果、DB情報を比較し、正データを選択・修正し確定。判断困難時はエスカレーション。
    8.  全項目の照合完了後、システムが完了データを生成。
    9.  管理者が完了CSVをアンケート管理画面からアップロード。
*   **3.4.3. 御礼メール送信フロー**
    1.  ユーザーがお礼メール設定画面で内容を設定・保存。
    2.  名刺データ化完了後、システムがユーザーに通知（または管理画面でステータス変更）。
    3.  ユーザーがお礼メール設定画面で送信対象を確認し、送信実行ボタンを押下。
    4.  システムが対象者リストに基づきメールを順次送信。
    5.  送信完了後、送信ステータスを更新。

**3.5. 横断的機能要件**

*   **3.5.1. 冪等性制御 (Idempotency Control)**
    *   **概要:** クライアントからの多重送信による意図しない再処理を防止するため、リクエストに一意の冪等性キーを付与し、サーバー側で同一キーの再利用を制御・管理する。
    *   **目的:**
        *   多重送信（ユーザーのボタン連打、ネットワーク瞬断、ブラウザの「戻る」からの再送信等）による処理の再実行（例: アンケートの二重回答登録、オペレーターの二重登録など）を防止する。
        *   複数端末（10台以上を想定）からの同時操作における安全性を高める。
        *   ユーザーエクスペリエンスを損なわずに安全なリクエスト実行を担保する。
        *   操作ログや将来的な監査対応も見据えた構成とする。
    *   **アクター:**
        *   エンドユーザー (クライアント端末操作者)
        *   APIサーバー (Laravelバックエンド)
        *   フロントエンドクライアント (Vue/React SPA)
        *   Redisストア (冪等性キーとレスポンスの一時保存先)
    *   **対象となる主な操作/エンドポイント:** 本書機能要件内で「【冪等性制御適用対象】」と記載されたすべてのデータ作成・更新・削除系API。
    *   **キー払い出しエンドポイント:**
        *   Path: `/api/idempotency-key`
        *   Method: `POST`
        *   Description: 操作単位の冪等性キーを払い出す。
        *   Request Body: `{ "operation": "string" }` (例: `"submit_survey_answer"`, `"create_operator"`)
        *   Response Body: `{ "idempotency_key": "string" }`
    *   **データ処理エンドポイント (対象操作のAPI):**
        *   Headers: `Idempotency-Key: string` (上記で取得したキーを使用)
    *   **サーバー側挙動:**
        *   **ミドルウェア (`CheckIdempotency`):**
            *   リクエストヘッダーの `Idempotency-Key` を検証。
            *   キーがRedisに存在する場合: キャッシュされたレスポンスを即座に返却し、後続処理（コントローラー等）は実行しない。
            *   キーが存在しない場合: リクエストを後続処理に渡し、その処理結果のレスポンスを生成後、キーと共にRedisにキャッシュ（TTL: 5分間 ※要検討）してからクライアントに返却する。
        *   キーが不正または欠如している場合は、400 Bad Request等のエラーを返却する。
    *   **フロントエンド側挙動:**
        *   **キー取得:** データ送信を伴う操作（フォーム送信ボタンクリック等）の直前に、`/api/idempotency-key` エンドポイントを呼び出し、冪等性キーを取得する。
        *   **リクエスト送信:** 取得した冪等性キーを `Idempotency-Key` ヘッダーに付加して、本来のデータ処理APIを呼び出す。
        *   **UI制御:**
            *   送信ボタンはクリック後、APIレスポンスが返るまで無効化する。
            *   処理中はローディングインジケーターやトースト通知を表示する。
        *   **再試行:** ネットワークエラー等でリクエストが失敗し、ユーザーが再試行する場合（または自動再試行する場合）は、初回に取得した同じ冪等性キーを再利用する。
    *   **備考:**
        *   冪等性キーは原則として1つのユーザー操作（例: 1回のフォーム送信）に対して1つ発行し、その操作が完了するまで（またはタイムアウトするまで）同じキーを使い続ける。
        *   副作用がある処理（DBへの書き込みなど）は、サーバー側で冪等性が保証されることにより、常に1度だけ実行される設計とする。
        *   Laravelのミドルウェアとして実装することで、対象ルートへの適用を一元管理し、再利用性と安全性を高める。
        *   CSRFトークンや認証トークンとは独立して機能し、併用することを前提とする。
    *   **将来的な考慮事項:**
        *   冪等性キーとユーザーID/操作種別/タイムスタンプ等をDBに記録し、操作監査ログとしての活用。
        *   キャッシュレスポンスの永続化オプションや署名付きレスポンスによる改ざん対策。
        *   高負荷時におけるキャッシュレスポンスの積極的な再利用によるDB負荷軽減とパフォーマンス向上。

### 4. 非機能要件

*   **4.1. 性能**
    *   通常時の画面応答時間: 3秒以内を目指す。
    *   アンケート回答画面の同時アクセス: [具体的な数値目標] 人程度を想定。
    *   データエクスポート処理時間: データ量に応じた現実的な時間内。
*   **4.2. 可用性**
    *   目標稼働率: 99.5% 以上（計画メンテナンス時間を除く）。
    *   障害発生時の目標復旧時間（RTO）: [具体的な時間目標]。
    *   データ損失の目標復旧時点（RPO）: [具体的な時間目標]。
*   **4.3. セキュリティ**
    *   【要件定義書(REP)】1-4. セキュリティ要件 1/4～4/4 に記載の項目を遵守する。
        *   SSL/TLSによる通信暗号化
        *   パスワードハッシュ化（Bcrypt）
        *   IPアドレス制限（管理画面）
        *   SQLインジェクション、XSS対策
        *   不正アクセス対策、アクセスログ監視
        *   Rootログイン禁止、SSH公開鍵認証
        *   不要なポート/サービスの無効化
        *   脆弱性情報の定期的な確認とパッチ適用
*   **4.4. 運用・保守**
    *   システム監視体制（サーバーリソース、エラーログ）。
    *   定期的なデータバックアップ。
    *   障害発生時の連絡体制と対応フロー。
    *   ソースコードのバージョン管理。
*   **4.5. UI/UX**
    *   直感的で分かりやすいインターフェース。
    *   レスポンシブデザイン（PC、タブレット、スマートフォンに対応）。
    *   主要ブラウザ（Chrome, Firefox, Edge, Safariの最新版）での動作保証。
    *   アクセシビリティへの配慮（可能な範囲）。

### 5. システム構成

*   **5.1. 全体構成**
    *   【要件定義書(REP)】1-3. サーバー構成図 を参照。
    *   インフラ基盤: AWS（オーストラリアリージョン）
    *   構成要素: WEBサーバー、DBサーバー、管理画面用サーバー、ロードバランサー（必要に応じて）、ファイルストレージ（S3等）
*   **5.2. ソフトウェア構成**
    *   OS: [Linux系OSを想定]
    *   Webサーバー: nginx
    *   APサーバー/言語: PHP / LaravelPHP
    *   DB: MySQL
    *   **キャッシュ/セッションストア: Redis** (冪等性キーとレスポンスのキャッシュにも利用)
    *   メール送信: Mailgun
    *   その他: JavaScript, jQuery, Vue.js/React (SPAフロントエンド) 等

### 6. データモデル
**6.1. 主要データエンティティ**
*   **Survey**: アンケート基本情報（ID, タイトル, 説明, 会期, 作成者ID, ステータス, 各種設定フラグ, 料金関連情報 等）
*   **Survey_detail**: アンケート設問情報に、選択した設問タイプに応じた詳細設定（文字数制限、数値範囲、選択肢JSON、マトリックス行列JSON、「その他」設定フラグ、最小/最大選択数等）を格納するカラムを追加。
*   **Answer**: アンケート回答ヘッダー情報（ID, SurveyID, 回答日時, IPアドレス, テスト回答フラグ, メール送信フラグ 等）
*   **Answer_detail**: アンケート回答詳細（ID, AnswerID, SurveyDetailID, 回答内容 等）
*   **Input_business_cards**: 名刺入力データ（ID, AnswerID, 項目グループID, 項目名, OCR結果, オペレーター入力1/2/3, 照合後データ, スキップフラグ/理由, エスカレーションフラグ, 入力完了フラグ, 担当オペレーターID 等）
*   **Users**: ユーザー情報（ID, 氏名, メールアドレス, パスワードハッシュ, 会社ID, 権限 等）
*   **Corporate**: 会社情報（ID, 会社名, 住所, 電話番号 等）
*   **Adminuser**: 管理者情報（ID, 氏名, メールアドレス, パスワードハッシュ, 権限 等）
*   **AdminUserGroup**: 管理者グループ情報（該当する場合）
*   **Coupon**: クーポン情報（ID, コード, 名称, 割引率, 有効期限, 利用回数制限 等）
*   **RewardHistory**: オペレーター実績履歴（ID, オペレーターID, グループID, 項目タイプ, 正誤フラグ 等）
*   その他、グループ管理用テーブル、カレンダー管理用テーブル等

### 7. インターフェース要件
**7.1. 冪等性キー払い出しAPI**
    *   エンドポイント: `POST /api/idempotency-key`
    *   詳細は上記「3.5.1. 冪等性制御」を参照。

### 8. 制約事項
*   開発期間: [開始日] ～ [終了日]
*   予算: [予算額]
*   開発体制: [開発会社名、担当者]
*   使用技術: 本書「5. システム構成」に記載の技術を基本とする。
